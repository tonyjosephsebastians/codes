import React, { useMemo, useState } from "react";

type EvidenceItem = {
  id?: string;
  page?: number;
  snippet?: string;
  page_markdown?: string;
};

type ExtractedElement = {
  id?: string;
  field_key?: string;
  field_name?: string;
  value?: any;
  confidence?: number;
  page?: number;
  source_snippet?: string;
  evidence?: EvidenceItem[];
};

type TableItem = {
  id?: string;
  table_id?: string;
  table_type?: "merged" | "page";
  source_page?: number;
  title?: string;
  columns?: string[];
  rows?: any;
  row_count?: number;
  has_unreadable?: boolean;
};

type ExtractionResponse = {
  extraction_run?: {
    id?: string;
    document_id?: string;
    uploaded_by?: string;
    standard?: string;
    pipeline_version?: string;
    status?: string;
    created_at?: string;
    completed_at?: string;
  };
  extracted_elements?: ExtractedElement[];
  tables?: {
    merged?: TableItem[];
    page?: TableItem[];
  };
};

function Badge({ children }: { children: React.ReactNode }) {
  return (
    <span className="inline-flex items-center rounded-full border border-stone-200 bg-white px-2 py-0.5 text-xs text-stone-600">
      {children}
    </span>
  );
}

function SectionCard({
  title,
  right,
  children,
}: {
  title: string;
  right?: React.ReactNode;
  children: React.ReactNode;
}) {
  return (
    <div className="bg-white rounded-xl border border-stone-200 shadow-sm">
      <div className="px-4 py-3 border-b border-stone-200 flex items-center justify-between gap-3">
        <div className="text-sm font-semibold text-stone-800 truncate">{title}</div>
        <div className="shrink-0">{right}</div>
      </div>
      <div className="p-4">{children}</div>
    </div>
  );
}

/** Simple accordion using <details> */
function AccordionItem({
  title,
  meta,
  children,
  defaultOpen = false,
}: {
  title: React.ReactNode;
  meta?: React.ReactNode;
  children: React.ReactNode;
  defaultOpen?: boolean;
}) {
  return (
    <details
      className="group rounded-lg border border-stone-200 bg-stone-50"
      open={defaultOpen}
    >
      <summary className="cursor-pointer list-none px-3 py-2 flex items-start justify-between gap-3">
        <div className="min-w-0">
          <div className="text-sm font-medium text-stone-800 truncate">{title}</div>
          {meta ? <div className="mt-1">{meta}</div> : null}
        </div>
        <div className="text-stone-500 group-open:rotate-180 transition-transform">▾</div>
      </summary>
      <div className="px-3 pb-3">{children}</div>
    </details>
  );
}

function prettyValue(v: any) {
  if (v === null || v === undefined) return "";
  if (typeof v === "string") return v;
  if (typeof v === "number" || typeof v === "boolean") return String(v);
  try {
    return JSON.stringify(v, null, 2);
  } catch {
    return String(v);
  }
}

function ConfidenceBar({ value }: { value?: number }) {
  const pct = Math.max(0, Math.min(1, value ?? 0)) * 100;
  return (
    <div className="flex items-center gap-2">
      <div className="h-2 w-24 bg-stone-200 rounded-full overflow-hidden">
        <div className="h-2 bg-emerald-600" style={{ width: `${pct}%` }} />
      </div>
      <span className="text-xs text-stone-600">{Math.round(pct)}%</span>
    </div>
  );
}

export function ExtractionPanel({ extractionRun }: { extractionRun: ExtractionResponse | null }) {
  const [query, setQuery] = useState("");

  const extracted = extractionRun?.extracted_elements ?? [];
  const mergedTables = extractionRun?.tables?.merged ?? [];
  const pageTables = extractionRun?.tables?.page ?? [];

  const filteredFields = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return extracted;
    return extracted.filter((f) => {
      const key = (f.field_key ?? f.field_name ?? "").toLowerCase();
      const val = prettyValue(f.value).toLowerCase();
      return key.includes(q) || val.includes(q);
    });
  }, [extracted, query]);

  return (
    <div className="space-y-4">
      {/* Header / Run summary */}
      <SectionCard
        title="Extraction"
        right={
          extractionRun?.extraction_run?.status ? (
            <Badge>{extractionRun.extraction_run.status}</Badge>
          ) : null
        }
      >
        {!extractionRun ? (
          <div className="text-sm text-stone-600">No extraction has been run yet.</div>
        ) : (
          <div className="space-y-3">
            <div className="flex flex-wrap gap-2">
              {extractionRun.extraction_run?.standard ? (
                <Badge>Standard: {extractionRun.extraction_run.standard}</Badge>
              ) : null}
              {extractionRun.extraction_run?.pipeline_version ? (
                <Badge>Pipeline: {extractionRun.extraction_run.pipeline_version}</Badge>
              ) : null}
              {extractionRun.extraction_run?.completed_at ? (
                <Badge>Completed: {extractionRun.extraction_run.completed_at}</Badge>
              ) : null}
            </div>

            <div className="grid grid-cols-3 gap-2">
              <div className="rounded-lg border border-stone-200 bg-white p-2">
                <div className="text-xs text-stone-500">Fields</div>
                <div className="text-lg font-semibold text-stone-800">{extracted.length}</div>
              </div>
              <div className="rounded-lg border border-stone-200 bg-white p-2">
                <div className="text-xs text-stone-500">Merged Tables</div>
                <div className="text-lg font-semibold text-stone-800">{mergedTables.length}</div>
              </div>
              <div className="rounded-lg border border-stone-200 bg-white p-2">
                <div className="text-xs text-stone-500">Page Tables</div>
                <div className="text-lg font-semibold text-stone-800">{pageTables.length}</div>
              </div>
            </div>
          </div>
        )}
      </SectionCard>

      {/* Fields */}
      <SectionCard
        title="Fields"
        right={
          <input
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            placeholder="Search…"
            className="w-40 rounded-md border border-stone-200 bg-white px-2 py-1 text-xs outline-none focus:ring-2 focus:ring-emerald-200"
          />
        }
      >
        {!extractionRun ? null : filteredFields.length === 0 ? (
          <div className="text-sm text-stone-600">No matching fields.</div>
        ) : (
          <div className="space-y-2">
            {filteredFields.map((f, idx) => (
              <AccordionItem
                key={f.id ?? `${f.field_key ?? f.field_name}_${idx}`}
                title={f.field_key ?? f.field_name ?? "field"}
                meta={
                  <div className="flex flex-wrap items-center gap-2">
                    {typeof f.page === "number" ? <Badge>Page {f.page}</Badge> : null}
                    <ConfidenceBar value={f.confidence} />
                  </div>
                }
              >
                {/* Value */}
                <div className="rounded-md border border-stone-200 bg-white p-2">
                  <div className="text-xs font-semibold text-stone-700 mb-1">Value</div>
                  {typeof f.value === "string" ? (
                    <div className="text-sm text-stone-800 whitespace-pre-wrap">{f.value}</div>
                  ) : (
                    <pre className="text-xs text-stone-700 whitespace-pre-wrap">
                      {prettyValue(f.value)}
                    </pre>
                  )}
                </div>

                {/* Evidence */}
                {f.evidence?.length ? (
                  <div className="mt-3 space-y-2">
                    <div className="text-xs font-semibold text-stone-700">Evidence</div>
                    {f.evidence.map((ev, eidx) => (
                      <div
                        key={ev.id ?? `${f.id}_ev_${eidx}`}
                        className="rounded-md border border-stone-200 bg-white p-2"
                      >
                        <div className="flex items-center gap-2 mb-1">
                          {typeof ev.page === "number" ? <Badge>Page {ev.page}</Badge> : null}
                          {ev.id ? <Badge>ID: {ev.id.slice(0, 8)}…</Badge> : null}
                        </div>
                        {ev.snippet ? (
                          <div className="text-sm text-stone-800 whitespace-pre-wrap">
                            {ev.snippet}
                          </div>
                        ) : null}
                        {ev.page_markdown ? (
                          <details className="mt-2">
                            <summary className="cursor-pointer text-xs text-emerald-700">
                              Show extracted markdown
                            </summary>
                            <pre className="mt-2 text-xs whitespace-pre-wrap text-stone-700 bg-stone-50 border border-stone-200 rounded-md p-2 overflow-auto">
                              {ev.page_markdown}
                            </pre>
                          </details>
                        ) : null}
                      </div>
                    ))}
                  </div>
                ) : null}
              </AccordionItem>
            ))}
          </div>
        )}
      </SectionCard>

      {/* Tables */}
      <SectionCard title="Tables">
        {!extractionRun ? null : mergedTables.length === 0 && pageTables.length === 0 ? (
          <div className="text-sm text-stone-600">No tables extracted.</div>
        ) : (
          <div className="space-y-3">
            {mergedTables.length ? (
              <div className="space-y-2">
                <div className="text-xs font-semibold text-stone-700">Merged</div>
                {mergedTables.map((t, idx) => (
                  <AccordionItem
                    key={t.id ?? `merged_${idx}`}
                    title={t.title ?? `Merged table ${idx + 1}`}
                    meta={
                      <div className="flex flex-wrap gap-2">
                        {typeof t.source_page === "number" ? <Badge>Source p{t.source_page}</Badge> : null}
                        {typeof t.row_count === "number" ? <Badge>{t.row_count} rows</Badge> : null}
                        {t.has_unreadable ? <Badge>Unreadable parts</Badge> : null}
                      </div>
                    }
                  >
                    <TablePreview table={t} />
                  </AccordionItem>
                ))}
              </div>
            ) : null}

            {pageTables.length ? (
              <div className="space-y-2">
                <div className="text-xs font-semibold text-stone-700">By page</div>
                {pageTables.map((t, idx) => (
                  <AccordionItem
                    key={t.id ?? `page_${idx}`}
                    title={t.title ?? `Page table ${idx + 1}`}
                    meta={
                      <div className="flex flex-wrap gap-2">
                        {typeof t.source_page === "number" ? <Badge>Page {t.source_page}</Badge> : null}
                        {typeof t.row_count === "number" ? <Badge>{t.row_count} rows</Badge> : null}
                        {t.has_unreadable ? <Badge>Unreadable parts</Badge> : null}
                      </div>
                    }
                  >
                    <TablePreview table={t} />
                  </AccordionItem>
                ))}
              </div>
            ) : null}
          </div>
        )}
      </SectionCard>
    </div>
  );
}

function TablePreview({ table }: { table: TableItem }) {
  // rows can be stringified json or array; handle both
  let rows: any[] = [];
  try {
    if (Array.isArray(table.rows)) rows = table.rows;
    else if (typeof table.rows === "string") rows = JSON.parse(table.rows);
  } catch {
    rows = [];
  }

  const cols = table.columns ?? (rows[0] ? Object.keys(rows[0]) : []);
  const previewRows = rows.slice(0, 8);

  if (!cols.length) {
    return (
      <pre className="text-xs whitespace-pre-wrap text-stone-700 bg-white border border-stone-200 rounded-md p-2 overflow-auto">
        {JSON.stringify(table, null, 2)}
      </pre>
    );
  }

  return (
    <div className="overflow-auto rounded-md border border-stone-200 bg-white">
      <table className="min-w-full text-xs">
        <thead className="bg-stone-50">
          <tr>
            {cols.map((c) => (
              <th key={c} className="text-left px-2 py-2 font-semibold text-stone-700 border-b border-stone-200">
                {c}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {previewRows.map((r, idx) => (
            <tr key={idx} className="border-b border-stone-100">
              {cols.map((c) => (
                <td key={c} className="px-2 py-2 text-stone-800 align-top">
                  {typeof r?.[c] === "string" ? r[c] : JSON.stringify(r?.[c] ?? "")}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>

      {rows.length > previewRows.length ? (
        <div className="px-2 py-2 text-xs text-stone-500">
          Showing {previewRows.length} of {rows.length} rows
        </div>
      ) : null}
    </div>
  );
}




import { ExtractionPanel } from "@/components/document-intelligence/ExtractionPanel";

...

<div className="grid grid-cols-12 gap-4">
  {/* LEFT: PDF */}
  <div className="col-span-8">
    <div className="bg-white rounded-xl border border-stone-200 shadow-sm p-4">
      {/* your existing PDFDocument + PDFPage list */}
    </div>
  </div>

  {/* RIGHT: Extraction */}
  <div className="col-span-4">
    <div className="sticky top-4 max-h-[calc(100vh-2rem)] overflow-auto">
      <ExtractionPanel extractionRun={extractionRun} />
    </div>
  </div>
</div>
