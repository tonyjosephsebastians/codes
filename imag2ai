import base64
from azure.identity import DefaultAzureCredential
from openai import AzureOpenAI
import mimetypes

# ==============================
# CONFIG
# ==============================

AZURE_OPENAI_ENDPOINT = "https://YOUR-RESOURCE-NAME.openai.azure.com/"
DEPLOYMENT_NAME = "gpt-4o"   # or your vision-enabled model deployment

# ==============================
# TOKEN PROVIDER (Managed Identity)
# ==============================

credential = DefaultAzureCredential()

def get_bearer_token():
    token = credential.get_token("https://cognitiveservices.azure.com/.default")
    return token.token

# ==============================
# CLIENT
# ==============================

client = AzureOpenAI(
    azure_endpoint=AZURE_OPENAI_ENDPOINT,
    azure_ad_token_provider=get_bearer_token,
    api_version="2024-02-15-preview"
)

# ==============================
# HELPER: Encode image
# ==============================

def image_to_base64(path: str):
    mime_type, _ = mimetypes.guess_type(path)
    with open(path, "rb") as f:
        return f"data:{mime_type};base64," + base64.b64encode(f.read()).decode("utf-8")

# ==============================
# SEND IMAGE
# ==============================

image_path = "sample.jpg"   # local image

image_data = image_to_base64(image_path)

response = client.chat.completions.create(
    model=DEPLOYMENT_NAME,
    messages=[
        {
            "role": "user",
            "content": [
                {"type": "text", "text": "What is in this image?"},
                {"type": "image_url", "image_url": {"url": image_data}}
            ]
        }
    ],
    max_tokens=200
)

print(response.choices[0].message.content)
